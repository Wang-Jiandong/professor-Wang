<script>
const path = location.pathname.split('/').pop() || 'index.html';
document.querySelectorAll('.nav a').forEach(a=>{
  if(a.getAttribute('href')===path) a.classList.add('active');
});

const mdUrl = 'content/team.md';

function esc(s){
  return (s||'').replace(/[&<>"']/g,m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function parseMd(md){
  const lines = md.replace(/\r/g,'').split('\n');

  let title = "研究团队";
  let paragraphs = [];
  let rows = [];

  let mode = "text";

  for(const raw of lines){
    const line = raw.trim();
    if(!line) continue;

    if(line.startsWith('# ')){
      title = line.slice(2).trim();
      continue;
    }

    if(line.startsWith('## ')){
      mode = "table";
      continue;
    }

    if(line.startsWith('//')) continue;

    if(mode==="text"){
      paragraphs.push(raw);
    }else{
      if(line.includes('|')){
        const parts = line.split('|');
        rows.push({
          name: parts[0].trim(),
          members: parts[1].trim()
        });
      }
    }
  }

  return {title, paragraphs, rows};
}

function render(data){
  document.querySelector('.detail-title').textContent = data.title;

  const stack = document.querySelector('.detail-stack');
  stack.innerHTML = '';

  // 文字段落
  data.paragraphs.forEach(p=>{
    stack.insertAdjacentHTML('beforeend',`
      <div class="stack-item">
        <p class="stack-p">${esc(p)}</p>
      </div>
    `);
  });

  // 表格
  let tableHTML = `
    <div class="stack-item">
      <div class="team-table-wrap">
        <table class="team-table">
          <thead>
            <tr>
              <th>团队名称</th>
              <th>团队主要成员</th>
            </tr>
          </thead>
          <tbody>
  `;

  data.rows.forEach(r=>{
    tableHTML += `
      <tr>
        <td>${esc(r.name)}</td>
        <td>${esc(r.members)}</td>
      </tr>
    `;
  });

  tableHTML += `
          </tbody>
        </table>
      </div>
    </div>
  `;

  stack.insertAdjacentHTML('beforeend',tableHTML);
}

fetch(mdUrl,{cache:'no-store'})
.then(r=>r.text())
.then(md=>render(parseMd(md)));
</script>
