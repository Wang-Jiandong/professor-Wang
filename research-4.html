<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>研究方向 | 新的研究方向</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <div class="shell">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar">
      <nav class="nav" aria-label="Site Navigation">
        <a href="index.html"><span class="pill"></span>团队主页</a>
        <a href="research.html"><span class="pill"></span>研究方向</a>
        <a href="papers.html"><span class="pill"></span>论文专著</a>
        <a href="team.html"><span class="pill"></span>研究团队</a>
      </nav>
    </aside>

    <!-- ===== Main ===== -->
    <main class="main">
      <div class="container">
        <section class="card">

          <!-- 标题：从 md 的 # 读取 -->
          <h1 class="detail-title" id="pageTitle">新的研究方向</h1>

          <div class="detail-stack" id="stackRoot"></div>

          <p class="backline"><a class="hot" href="research.html">← 返回研究方向</a></p>

          <!-- 兜底提示（md 读不到时显示） -->
          <div class="stack-item" id="fallbackBox" style="display:none; margin-top:14px;">
            <div class="stack-h">提示</div>
            <p class="stack-p" style="margin:0;">
              未能读取 <b>content/research-4.md</b>，请检查文件是否存在以及路径是否正确。
            </p>
          </div>

        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== nav 高亮 =====
    const path = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.nav a').forEach(a=>{
      if(a.getAttribute('href')===path) a.classList.add('active');
    });

    // ===== 配置：读取哪个 md =====
    const mdUrl = 'content/research-4.md';

    function escHtml(s){
      return (s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // 解析规则（老师只写纯文字）：
    // # 标题
    // ## 研究背景 / ## 研究目标 / ## 主要思路 / ## 应用案例 / ## 技术细节
    // 视频：在任意段落中写一行：视频：assets/媒体4.mp4
    // （我们会把视频放进“应用案例”同一个框里；若不在应用案例里写，也会放到对应段落里）
    function parseMd(md){
      const lines = md.replace(/\r\n/g, '\n').split('\n');

      let title = '新的研究方向';
      const sections = []; // {h, pLines:[], videoSrc:''}

      let cur = null;

      function pushCur(){
        if(!cur) return;
        // 合并文本
        cur.p = cur.pLines.join('\n').trim();
        delete cur.pLines;
        sections.push(cur);
        cur = null;
      }

      for(const rawLine of lines){
        const line = rawLine.trim();
        if(!line) continue;

        if(line.startsWith('# ')){
          title = line.slice(2).trim() || title;
          continue;
        }

        if(line.startsWith('## ')){
          pushCur();
          cur = { h: line.slice(3).trim(), pLines: [], videoSrc: '' };
          continue;
        }

        // 视频行：视频：assets/xxx.mp4
        if(line.startsWith('视频：')){
          const src = line.replace(/^视频：/,'').trim();
          if(cur) cur.videoSrc = src;
          continue;
        }

        // 普通文字
        if(!cur){
          // 如果老师没写 ##，也不至于丢内容：自动归到“说明”
          cur = { h: '说明', pLines: [], videoSrc: '' };
        }
        cur.pLines.push(rawLine);
      }
      pushCur();

      return { title, sections };
    }

    function buildSectionHTML(sec){
      const h = escHtml(sec.h || '');
      const p = escHtml(sec.p || '').replace(/\n/g, '<br>');

      // 视频块：完全沿用你 research-1 的写法（同框内 video-wrap video-small）
      const videoHtml = sec.videoSrc
        ? `
          <div class="video-wrap video-small" style="margin-top:12px;">
            <video controls preload="metadata" style="width:90%; display:block; margin:0 auto;">
              <source src="${escHtml(sec.videoSrc)}" type="video/mp4">
            </video>
          </div>
        `
        : '';

      return `
        <div class="stack-item">
          <div class="stack-h">${h}</div>
          <p class="stack-p">${p}</p>
          ${videoHtml}
        </div>
      `;
    }

    function render(data){
      // 标题 + 浏览器标题
      document.getElementById('pageTitle').textContent = data.title || '新的研究方向';
      document.title = '研究方向 | ' + (data.title || '新的研究方向');

      const root = document.getElementById('stackRoot');
      root.innerHTML = '';

      if(!data.sections || data.sections.length === 0){
        document.getElementById('fallbackBox').style.display = '';
        return;
      }

      // 确保“应用案例”存在时，视频会在同一个框内（老师只要把 视频： 写在应用案例下面）
      data.sections.forEach(sec=>{
        root.insertAdjacentHTML('beforeend', buildSectionHTML(sec));
      });
    }

    fetch(mdUrl, { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(md => render(parseMd(md)))
      .catch(err => {
        console.error(err);
        document.getElementById('fallbackBox').style.display = '';
      });
  </script>
</body>
</html>
