<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>研究方向 | 新的研究方向</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <div class="shell">
    <aside class="sidebar">
      <nav class="nav" aria-label="Site Navigation">
        <a href="index.html"><span class="pill"></span>团队主页</a>
        <a href="research.html"><span class="pill"></span>研究方向</a>
        <a href="papers.html"><span class="pill"></span>论文专著</a>
        <a href="team.html"><span class="pill"></span>研究团队</a>
      </nav>
    </aside>

    <main class="main">
      <div class="container">
        <section class="card">

          <h1 class="detail-title" id="pageTitle">新的研究方向</h1>

          <div class="detail-stack" id="stackRoot"></div>

          <p class="backline"><a class="hot" href="research.html">← 返回研究方向</a></p>

          <div class="stack-item" id="fallbackBox" style="display:none; margin-top:14px;">
            <div class="stack-h">提示</div>
            <p class="stack-p" style="margin:0;">
              未能读取 <b>content/research-4.md</b>，请检查文件是否存在以及路径是否正确。
            </p>
          </div>

        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== nav 高亮 =====
    const path = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.nav a').forEach(a=>{
      if(a.getAttribute('href')===path) a.classList.add('active');
    });

    const mdUrl = 'content/research-4.md';

    function escHtml(s){
      return (s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // 解析规则：
    // # 标题
    // ## 段落标题
    // 视频：视频：assets/xxx.mp4（放在本段落同框）
    // 论文专著：论文专著：XXX方向的代表性论文。
    function parseMd(md){
      const lines = md.replace(/\r\n/g, '\n').split('\n');

      let title = '新的研究方向';
      const sections = []; // {h, pLines:[], videoSrc:''}
      let paperTail = '';  // 技术细节里“—— 后半句”
      let cur = null;

      function pushCur(){
        if(!cur) return;
        cur.p = cur.pLines.join('\n').trim();
        delete cur.pLines;
        sections.push(cur);
        cur = null;
      }

      for(const rawLine of lines){
        const line = rawLine.trim();
        if(!line) continue;

        if(line.startsWith('# ')){
          title = line.slice(2).trim() || title;
          continue;
        }
        if(line.startsWith('## ')){
          pushCur();
          cur = { h: line.slice(3).trim(), pLines: [], videoSrc: '' };
          continue;
        }
        if(line.startsWith('视频：')){
          const src = line.replace(/^视频：/,'').trim();
          if(cur) cur.videoSrc = src;
          continue;
        }
        if(line.startsWith('论文专著：')){
          paperTail = line.replace(/^论文专著：/,'').trim();
          continue;
        }

        if(!cur){
          cur = { h: '说明', pLines: [], videoSrc: '' };
        }
        cur.pLines.push(rawLine);
      }
      pushCur();

      return { title, sections, paperTail };
    }

    function buildSectionHTML(sec){
      const h = escHtml(sec.h || '');
      const p = escHtml(sec.p || '').replace(/\n/g, '<br>');

      const videoHtml = sec.videoSrc
        ? `
          <div class="video-wrap video-small" style="margin-top:12px;">
            <video controls preload="metadata" style="width:90%; display:block; margin:0 auto;">
              <source src="${escHtml(sec.videoSrc)}" type="video/mp4">
            </video>
          </div>
        ` : '';

      return `
        <div class="stack-item">
          <div class="stack-h">${h}</div>
          <p class="stack-p">${p}</p>
          ${videoHtml}
        </div>
      `;
    }

    // ✅ 固定前半句 + 可变后半句（从 md 读取）
    function techBlockHTML(paperTail){
      const tail = paperTail ? escHtml(paperTail) : '本研究方向的代表性论文。';
      return `
        <div class="stack-item">
          <div class="stack-h">技术细节</div>
          <p class="stack-p">
            详见 <a class="hot" href="papers.html">“论文专著”</a> 部分 —— ${tail}
          </p>
        </div>
      `;
    }

    function render(data){
      document.getElementById('pageTitle').textContent = data.title || '新的研究方向';
      document.title = '研究方向 | ' + (data.title || '新的研究方向');

      const root = document.getElementById('stackRoot');
      root.innerHTML = '';

      if(!data.sections || data.sections.length === 0){
        document.getElementById('fallbackBox').style.display = '';
        return;
      }

      data.sections.forEach(sec=>{
        root.insertAdjacentHTML('beforeend', buildSectionHTML(sec));
      });

      // ✅ 最后追加技术细节（尾巴来自 md）
      root.insertAdjacentHTML('beforeend', techBlockHTML(data.paperTail));
    }

    fetch(mdUrl, { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(md => render(parseMd(md)))
      .catch(err => {
        console.error(err);
        document.getElementById('fallbackBox').style.display = '';
      });
  </script>
</body>
</html>
