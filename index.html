<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>团队主页</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <div class="shell">
    <aside class="sidebar">
      <nav class="nav" aria-label="Site Navigation">
        <a href="index.html"><span class="pill"></span>团队主页</a>
        <a href="research.html"><span class="pill"></span>研究方向</a>
        <a href="papers.html"><span class="pill"></span>论文专著</a>
        <a href="team.html"><span class="pill"></span>研究团队</a>
      </nav>
    </aside>

    <main class="main">
      <div class="container">
        <section class="card">

          <h1 class="page-title" id="homeTitle">欢迎访问我们的研究团队！</h1>

          <div class="grid" id="homeGrid"></div>

          <h2 class="section-title" id="contactTitle">联系方式</h2>
          <div class="contact" id="contactBox"></div>

          <div class="stack-item" id="fallbackBox" style="display:none; margin-top:14px;">
            <div class="stack-h">提示</div>
            <p class="stack-p" style="margin:0;">
              未能读取 <b>content/主页.md</b>，请检查文件是否存在以及路径是否正确。
            </p>
          </div>

        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== nav 高亮 =====
    const path = location.pathname.split('/').pop() || 'index.html';
    document.querySelectorAll('.nav a').forEach(a=>{
      if(a.getAttribute('href')===path) a.classList.add('active');
    });

    const mdUrl = 'content/index.md';

    function escHtml(s){
      return (s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // 解析规则（只给老师看文字，不碰代码）：
    // # 主标题
    // ## 导语1 / ## 导语2（会变成两个 info-box）
    // ## 联系方式（下面用“字段：内容”）
    //
    // 示例：
    // 电话：186...
    // Email：xxx@xxx
    function parseHomeMd(md){
      const lines = md.replace(/\r\n/g,'\n').split('\n');

      let title = '欢迎访问我们的研究团队！';
      const boxes = [];        // [{title:'', textLines:[]}]
      const contact = [];      // [{k,v}]
      let cur = null;
      let inContact = false;

      function pushBox(){
        if(cur && cur.textLines.length){
          boxes.push({
            title: cur.title || '',
            text: cur.textLines.join('\n').trim()
          });
        }
        cur = null;
      }

      for(const raw of lines){
        const t = raw.trim();
        if(!t) continue;

        // 忽略以 // 开头的“说明注释”
        if(t.startsWith('//')) continue;

        if(t.startsWith('# ')){
          title = t.slice(2).trim() || title;
          continue;
        }

        if(t.startsWith('## ')){
          pushBox();
          const h = t.slice(3).trim();

          if(h === '联系方式'){
            inContact = true;
            cur = null;
          }else{
            inContact = false;
            cur = { title: h, textLines: [] };
          }
          continue;
        }

        if(inContact){
          // 联系方式用：字段：内容
          const idx = t.indexOf('：');
          if(idx > 0){
            const k = t.slice(0, idx).trim();
            const v = t.slice(idx+1).trim();
            if(k && v) contact.push({k, v});
          }else{
            // 容错：没有冒号就当作一行备注
            contact.push({k:'', v:t});
          }
          continue;
        }

        // 正文写入 box
        if(!cur) cur = { title: '说明', textLines: [] };
        cur.textLines.push(raw);
      }

      pushBox();
      return { title, boxes, contact };
    }

    function renderHome(data){
      // 标题
      document.getElementById('homeTitle').textContent = data.title || '欢迎访问我们的研究团队！';
      document.title = (data.title || '团队主页');

      // 两个 info-box
      const grid = document.getElementById('homeGrid');
      grid.innerHTML = '';
      (data.boxes || []).slice(0,2).forEach(b=>{
        const html = `
          <div class="info-box">
            <p>${escHtml(b.text).replace(/\n/g,'<br>')}</p>
          </div>
        `;
        grid.insertAdjacentHTML('beforeend', html);
      });

      // 联系方式
      const cb = document.getElementById('contactBox');
      cb.innerHTML = '';
      (data.contact || []).forEach(row=>{
        if(row.k){
          cb.insertAdjacentHTML('beforeend',
            `<div><b>${escHtml(row.k)}：</b>${escHtml(row.v)}</div>`
          );
        }else{
          cb.insertAdjacentHTML('beforeend',
            `<div>${escHtml(row.v)}</div>`
          );
        }
      });
    }

    fetch(mdUrl, { cache: 'no-store' })
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(md => renderHome(parseHomeMd(md)))
      .catch(err => {
        console.error(err);
        document.getElementById('fallbackBox').style.display = '';
      });
  </script>
</body>
</html>
